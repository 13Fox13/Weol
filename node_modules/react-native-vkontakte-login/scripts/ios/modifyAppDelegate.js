"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var balanced_match_1 = __importDefault(require("balanced-match"));
var fs_1 = __importDefault(require("fs"));
var PRJ_IMPORT = '#import <VKSdkFramework/VKSdkFramework.h>';
var PODS_IMPORT = '#import "VKSdk.h"';
var APP_DELEGATE_HEADER = "\n#if __has_include(<VKSdkFramework/VKSdkFramework.h>)\n" + PRJ_IMPORT + "\n#else\n" + PODS_IMPORT + "\n#endif\n";
var APP_DELEGATE_CODE = "\n\n//iOS 9 workflow\n- (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary<NSString *,id> *)options {\n    [VKSdk processOpenURL:url fromApplication:options[UIApplicationOpenURLOptionsSourceApplicationKey]];\n    return YES;\n}\n\n//iOS 8 and lower\n-(BOOL)application:(UIApplication *)application openURL:(NSURL *)url sourceApplication:(NSString *)sourceApplication annotation:(id)annotation\n{\n    [VKSdk processOpenURL:url fromApplication:sourceApplication];\n    return YES;\n}\n";
function modifyAppDelegate(appDelegatePath) {
    var content = fs_1.default.readFileSync(appDelegatePath, 'utf8');
    if (content.indexOf(PODS_IMPORT) === -1 && content.indexOf(PRJ_IMPORT) === -1) {
        var match = content.match(/#import "AppDelegate.h"[ \t]*\r*\n/);
        if (match === null) {
            console.warn("Could not find line '#import \"AppDelegate.h\"' in file AppDelegate.m.\n      You have to update AppDelegate.m manually");
            return;
        }
        var existingLine = match[0];
        content = content.replace(existingLine, "" + existingLine + APP_DELEGATE_HEADER + "\n");
    }
    else {
        console.log('VK iOS SDK header already added to AppDelegate.m');
    }
    if (content.indexOf(APP_DELEGATE_CODE) === -1) {
        if (content.indexOf('openURL') !== -1) {
            console.warn("Looks like you already have openURL method(s) in your AppDelegate.m\n      Maybe already added Facebook login? In this case you have to update AppDelegate.m manually");
            return;
        }
        var start = content.indexOf('didFinishLaunchingWithOptions');
        var tail = content.substr(start);
        var end = balanced_match_1.default('{', '}', tail).end;
        var insertAt = start + end + 1;
        content = content.slice(0, insertAt) + APP_DELEGATE_CODE + content.slice(insertAt);
    }
    else {
        console.log('VK iOS SDK openURL methods already added to AppDelegate.m');
    }
    fs_1.default.writeFileSync(appDelegatePath, content);
}
exports.default = modifyAppDelegate;
